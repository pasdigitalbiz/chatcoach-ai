<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dating Buddy ğŸ’˜</title>
  <style>
    body {
      background-color: #FFE082;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      padding: 2rem;
      margin: 0 auto;
      max-width: 600px;
    }
    h1 {
      text-align: center;
      font-size: 2rem;
      margin-bottom: 1rem;
      color: #000;
    }
    textarea, input[type="file"], select {
      width: 100%;
      margin-top: 1rem;
      padding: 0.8rem;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background-color: #ff5f7e;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-top: 1rem;
      padding: 0.8rem;
      font-size: 1rem;
      border-radius: 8px;
    }
    #outputContainer {
      margin-top: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .responseBox {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .copyBtn {
      background-color: #ff5f7e;
      color: white;
      border: none;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
      border-radius: 5px;
      cursor: pointer;
    }
    @media screen and (max-width: 600px) {
      body {
        padding: 1rem;
      }
      h1 {
        font-size: 1.5rem;
      }
      .responseBox {
        flex-direction: column;
        align-items: flex-start;
      }
      .copyBtn {
        margin-top: 0.5rem;
        width: 100%;
      }
    }
  </style>

  <!-- Banner top (728x90) -->
  <script type="text/javascript">
    atOptions = {
      'key': '42b9d9fd1193ed5de63786f50f878579',
      'format': 'iframe',
      'height': 90,
      'width': 728,
      'params': {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/42b9d9fd1193ed5de63786f50f878579/invoke.js"></script>
</head>

<body>
  <h1>Dating Buddy ğŸ’˜</h1>
  <p id="intro" style="text-align: center; font-size: 1rem; color: #333; margin-top: 0.5rem; font-style: italic;"></p>

  <textarea id="inputText" rows="4" placeholder=""></textarea>
  <input type="file" id="imageUpload" accept="image/*" />

  <select id="tone"></select>
  <select id="language"></select>

  <label style="display: block; margin-top: 1rem;">
    <input type="checkbox" id="privacyCheckbox" />
    <span id="privacyText"></span>
    <a href="/privacy.html" target="_blank">ğŸ“„</a>
  </label>

  <button onclick="generateResponse()" id="generateBtn">Genera</button>

  <!-- Native ad below button -->
  <script async="async" data-cfasync="false" src="//pl26693406.profitableratecpm.com/eec2d9225eb66ab40928c5bfa35319f4/invoke.js"></script>
  <div id="container-eec2d9225eb66ab40928c5bfa35319f4"></div>

  <div id="outputContainer"></div>

  <!-- Banner footer (300x250) -->
  <script type="text/javascript">
    atOptions = {
      'key': 'd9eb03cc5952f21814f97f53de73c437',
      'format': 'iframe',
      'height': 250,
      'width': 300,
      'params': {}
    };
  </script>
  <script type="text/javascript" src="//www.highperformanceformat.com/d9eb03cc5952f21814f97f53de73c437/invoke.js"></script>

  <!-- Popunder + SocialBar -->
  <script type='text/javascript' src='//pl26693444.profitableratecpm.com/9e/5e/62/9e5e62001fe70e118929e80327fc0e6e.js'></script>
  <script type='text/javascript' src='//pl26693436.profitableratecpm.com/6f/89/95/6f8995af99479724442477f099bbf6cf.js'></script>

  <script>
    const translations = {
      it: {
        intro: "ğŸ’¬ Hai un match ma non sai come rispondere?<br/>Dating Buddy ti aiuta a scrivere messaggi brillanti, naturali e pronti allâ€™uso.<br/>Puoi anche caricare uno screenshot per ricevere consigli su misura.",
        placeholder: "Scrivi qui il messaggio ricevuto o carica uno screenshot...",
        button: "Cosa rispondo?",
        checkbox: "Ho letto e accetto la Privacy Policy",
        tones: ["ğŸ˜„ Divertente", "ğŸ’˜ Romantico", "ğŸ˜ Sicuro di sÃ©", "ğŸ˜ˆ Malizioso"],
        languages: ["ğŸ‡®ğŸ‡¹ Italiano", "ğŸ‡¬ğŸ‡§ Inglese", "ğŸ‡«ğŸ‡· Francese", "ğŸ‡©ğŸ‡ª Tedesco", "ğŸ‡ªğŸ‡¸ Spagnolo"]
      },
      en: {
        intro: "ğŸ’¬ Got a match and don't know what to reply?<br/>Dating Buddy helps you write witty, natural, ready-to-use messages.<br/>You can also upload a screenshot for personalized advice.",
        placeholder: "Type the message received or upload a screenshot...",
        button: "What should I reply?",
        checkbox: "I have read and accept the Privacy Policy",
        tones: ["ğŸ˜„ Funny", "ğŸ’˜ Romantic", "ğŸ˜ Confident", "ğŸ˜ˆ Flirty"],
        languages: ["ğŸ‡¬ğŸ‡§ English", "ğŸ‡®ğŸ‡¹ Italian", "ğŸ‡«ğŸ‡· French", "ğŸ‡©ğŸ‡ª German", "ğŸ‡ªğŸ‡¸ Spanish"]
      },
      fr: {
        intro: "ğŸ’¬ Un match mais tu ne sais pas quoi rÃ©pondre ?<br/>Dating Buddy tâ€™aide Ã  Ã©crire des messages brillants, naturels et prÃªts Ã  lâ€™emploi.<br/>Tu peux aussi tÃ©lÃ©charger une capture pour des conseils personnalisÃ©s.",
        placeholder: "Ã‰cris ici le message reÃ§u ou tÃ©lÃ©verse une capture...",
        button: "Que rÃ©pondre ?",
        checkbox: "Jâ€™ai lu et jâ€™accepte la politique de confidentialitÃ©",
        tones: ["ğŸ˜„ DrÃ´le", "ğŸ’˜ Romantique", "ğŸ˜ Confiant", "ğŸ˜ˆ Coquin"],
        languages: ["ğŸ‡«ğŸ‡· FranÃ§ais", "ğŸ‡¬ğŸ‡§ Anglais", "ğŸ‡®ğŸ‡¹ Italien", "ğŸ‡©ğŸ‡ª Allemand", "ğŸ‡ªğŸ‡¸ Espagnol"]
      },
      de: {
        intro: "ğŸ’¬ Ein Match â€“ aber du weiÃŸt nicht, was du antworten sollst?<br/>Dating Buddy hilft dir, brillante, natÃ¼rliche Nachrichten zu schreiben.<br/>Du kannst auch einen Screenshot hochladen fÃ¼r individuelle Tipps.",
        placeholder: "Gib hier die erhaltene Nachricht ein oder lade einen Screenshot hoch...",
        button: "Was soll ich antworten?",
        checkbox: "Ich habe die Datenschutzrichtlinie gelesen und akzeptiert",
        tones: ["ğŸ˜„ Lustig", "ğŸ’˜ Romantisch", "ğŸ˜ Selbstbewusst", "ğŸ˜ˆ Frech"],
        languages: ["ğŸ‡©ğŸ‡ª Deutsch", "ğŸ‡®ğŸ‡¹ Italienisch", "ğŸ‡¬ğŸ‡§ Englisch", "ğŸ‡«ğŸ‡· FranzÃ¶sisch", "ğŸ‡ªğŸ‡¸ Spanisch"]
      },
      es: {
        intro: "ğŸ’¬ Â¿Tienes un match y no sabes quÃ© responder?<br/>Dating Buddy te ayuda a escribir mensajes brillantes, naturales y listos para usar.<br/>TambiÃ©n puedes subir una captura para consejos personalizados.",
        placeholder: "Escribe aquÃ­ el mensaje recibido o sube una captura...",
        button: "Â¿QuÃ© respondo?",
        checkbox: "He leÃ­do y acepto la PolÃ­tica de Privacidad",
        tones: ["ğŸ˜„ Divertido", "ğŸ’˜ RomÃ¡ntico", "ğŸ˜ Seguro de sÃ­", "ğŸ˜ˆ Picante"],
        languages: ["ğŸ‡ªğŸ‡¸ EspaÃ±ol", "ğŸ‡¬ğŸ‡§ InglÃ©s", "ğŸ‡®ğŸ‡¹ Italiano", "ğŸ‡«ğŸ‡· FrancÃ©s", "ğŸ‡©ğŸ‡ª AlemÃ¡n"]
      }
    };

    const lang = navigator.language.slice(0, 2);
    const t = translations[lang] || translations["en"];

    document.getElementById("intro").innerHTML = t.intro;
    document.getElementById("inputText").placeholder = t.placeholder;
    document.getElementById("generateBtn").textContent = t.button;
    document.getElementById("privacyText").textContent = t.checkbox;

    const toneSelect = document.getElementById("tone");
    t.tones.forEach((tone, index) => {
      const opt = document.createElement("option");
      opt.value = tone;
      opt.textContent = tone;
      toneSelect.appendChild(opt);
    });

    const languageSelect = document.getElementById("language");
    t.languages.forEach((lang, index) => {
      const opt = document.createElement("option");
      opt.textContent = lang;
      languageSelect.appendChild(opt);
    });

    let isBlocked = false;
    let requestTimestamps = JSON.parse(localStorage.getItem("generationTimestamps")) || [];

    function checkSpamAndSetBlock() {
      const now = Date.now();
      requestTimestamps = requestTimestamps.filter(t => now - t < 30000);
      if (requestTimestamps.length >= 3) {
        isBlocked = true;
        alert("Stai andando troppo veloce! Aspetta 1 minuto prima di generare nuove risposte.");
        document.getElementById("generateBtn").disabled = true;
        setTimeout(() => {
          isBlocked = false;
          document.getElementById("generateBtn").disabled = false;
        }, 60000);
        return true;
      }
      requestTimestamps.push(now);
      localStorage.setItem("generationTimestamps", JSON.stringify(requestTimestamps));
      return false;
    }

    async function extractTextFromImage(file) {
      const formData = new FormData();
      formData.append("file", file);
      const response = await fetch("https://api.ocr.space/parse/image", {
        method: "POST",
        headers: { apikey: "helloworld" },
        body: formData
      });
      const data = await response.json();
      return data.ParsedResults?.[0]?.ParsedText || "";
    }

    async function generateResponse() {
      if (isBlocked) {
        alert("Aspetta qualche secondo prima di riprovare.");
        return;
      }
      if (!document.getElementById("privacyCheckbox").checked) {
        alert("Per favore, accetta la Privacy Policy.");
        return;
      }
      if (checkSpamAndSetBlock()) return;

      const inputText = document.getElementById("inputText").value;
      const tone = document.getElementById("tone").value;
      const language = document.getElementById("language").value;
      const image = document.getElementById("imageUpload").files[0];

      let finalInput = inputText;
      if (image) {
        const extractedText = await extractTextFromImage(image);
        finalInput = inputText + "\n" + extractedText;
      }

      if (!finalInput.trim()) {
        alert("Inserisci un testo o carica uno screenshot");
        return;
      }

      const payload = { inputText: finalInput, tone, language };

      try {
        const res = await fetch("/api/generate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        const container = document.getElementById("outputContainer");
        container.innerHTML = "";

        if (data.output) {
          const responses = data.output.split(/\n+/).filter(r => r.trim() !== "");
          responses.forEach(resp => {
            const box = document.createElement("div");
            box.className = "responseBox";
            box.innerHTML = `<span>${resp}</span><button class='copyBtn' onclick='navigator.clipboard.writeText(\`${resp.replace(/`/g, "\\`")}\`)'>ğŸ“‹ Copia</button>`;
            container.appendChild(box);
          });
        } else {
          container.textContent = "Nessuna risposta generata.";
        }
      } catch (err) {
        document.getElementById("outputContainer").textContent = "Errore: " + err.message;
      }
    }
  </script>
</body>
</html>
